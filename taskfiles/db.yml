version: 3

env:
  DB_HOST: 127.0.0.1
  DB_PORT: 3306
  DB_USER: isucon
  DB_PASS: isucon
  DB_NAME: isucondition

  # MySQL
  MYSQL_LOG: /tmp/slow-query.log

tasks:
  msql:
    desc: MySQL
    cmds:
      - mysql -h$(DB_HOST) -P$(DB_PORT) -u$(DB_USER) -p$(DB_PASS) $(DB_NAME)

  restart:
    desc: MySQL再起動
    cmds:
      - sudo systemctl restart mysql.service

  initialize-schema:
    desc: MYSQLスキーマ初期化
    cmds:
      - $(MYSQL_CMD) < $(PROJECT_ROOT)/sql/schema.sql

  disable-redolog:
    desc: MySQL(^8.0.21) Redoログ無効化
    cmds:
      - ${MYSQL_CMD} -e'ALTER INSTANCE DISABLE INNODB REDO_LOG'

  slow:
    desc: pt-query-digest の結果をDiscordに投げる
    cmds:
      - sudo pt-query-digest $(MYSQL_LOG) > /tmp/query-digest.log
      - $(DISCORDFILE) /tmp/query-digest.log

  slow-on:
    - sudo mysql -e "set global slow_query_log_file = '$(MYSQL_LOG)'; set global long_query_time = 0; set global slow_query_log = ON;"

  slow-off:
    - sudo mysql -e "set global slow_query_log = OFF;"
